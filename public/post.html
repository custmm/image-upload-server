<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="kMxKqlA9cKbHdJGw51M2sE21fjyzL3SvY1ryWISJMT0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>â±¯íœ´ìš±ìŠˆìš±â±¯ >> ê²Œì‹œë¬¼</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ë¼ì´íŠ¸ ëª¨ë“œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      text-align: center;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
    }
    /* ğŸ”¥ ê·¸ë¦¼ ê·¸ë¦¬ê¸° íŒì—…ì°½ ìŠ¤íƒ€ì¼ */
    .drawing-popup {
        display: none;
        border-radius: 5px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 85%;
        height: 400px;
        background: #c0c0c065;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        padding: 10px;
        border: 1px solid #ccc;
    }
    /* âœ… ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
    .loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        justify-content: center;
        align-items: center;
        flex-direction: column; /* ì´ë¯¸ì§€ + í…ìŠ¤íŠ¸ ì„¸ë¡œ ì •ë ¬ */
        z-index: 9999; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
        text-align: center;
    }
    /* âœ… ë¡œë”© ì´ë¯¸ì§€ í¬ê¸° */
    .loading-image {
        width: 50px;
        height: 50px;
        margin-bottom: 10px; /* ì´ë¯¸ì§€ ì•„ë˜ ì—¬ë°± */
    }

    /* âœ… ë¡œë”© í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .loading-text {
        font-size: 16px;
        color: white;
    }

    .post-container{
        display: flex;
        background-color: #ffffff;
        border-radius: 10px;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
        width: 500px;
        margin: 20px auto;
    }
    .postcategory-container{
      display: flex;
      border: 1px solid #ccc;
      border-radius: 5px;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      width: flex;
      height: auto;
      padding: 10px;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    .postcategory-container > div {
        margin: 0 10px;
    }
    .postcategory-container > div > img {
        width: 30px;
        height: 30px;
        margin-right: 5px;
    }
    .postcategory-container > div > span {
        font-size: 16px;
    }
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 10px;
    }
    .popup-title {
      flex-grow: 1;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }
    .close-popup {
      color: red;
      border: none;
      cursor: pointer;
      font-size: 18px;
      background: none;
      padding: 5px;
    }
    .close-popup:hover {
      color: aqua;
      background: none;
    }
    .popup-footer {
        margin-top: 10px;
    }
    #drawingCanvas {
      width: 100%;
      height: 300px;
      background: #fff;
      border: 1px solid #000;
      border-radius: 8px;
      cursor: crosshair;
      display: block;
    }
    /* âœ… í´ë¦­ ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .clickable-category {
      cursor: pointer;
      color: black;
    }

    .clickable-category:hover {
      color: darkblue;
    }
    .popup-message {
      position: fixed;
      width: 300px;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      color: #000;
      padding: 18px 20px;
      border-radius: 8px;
      box-shadow: 0px 5px 15px rgba(0,0,0,0.3);
      z-index: 10000;
      text-align: center;
      display: none;
    }
    .popup-button {
      margin-top: 15px;
      padding: 10px 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }    
    .custom-button {
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .popup-button:hover,
    .custom-button:hover {
      background-color: aqua;
    }
    /* âœ… ê²Œì‹œë¬¼ ì´ë¯¸ì§€ */
    .post-image {
        max-width: 100%;
        max-height: 50vh;
        object-fit: contain;
    }

    /* âœ… ê²Œì‹œë¬¼ ì„¤ëª… */
    .post-description {
        font-size: 16px;
        text-align: left;
        white-space: pre-wrap; /* newline ë¬¸ì ë³´ì¡´ */
    }
    .post-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .button {
      font-size: 16px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .button:hover {
      background-color: #755a6a;
    }
    .hashtag-link {
      color: #1da1f2;
      text-decoration: none;
    }

    .hashtag-link:hover {
      text-decoration: underline;
    }
    /* í† ê¸€ ìŠ¤ìœ„ì¹˜ (ë‹¤í¬ ëª¨ë“œ) */
    .toggle-switch {
      position: absolute;
      top: 10px;
      right: 30px;
      width: 50px;
      height: 25px;
      display: inline-block;
    }

    .toggle-switch input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      opacity: 0;
      cursor: pointer;
      z-index: 2;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      width: 100%;
      height: 100%;
      background-color: #cbcbcb;
      border-radius: 20px;
      transition: background-color 0.3s;
    }
    #themeIcon {
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      bottom: 2px;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      pointer-events: none;
      transition: transform 0.3s;
      z-index: 1;
    }
    .slider::before {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      bottom: 2px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
      z-index: 0;
    }
    .toggle-switch input:checked + .slider::before {
      transform: translateX(25px);
    }

    .toggle-switch input:checked + .slider #themeIcon {
      transform: translateX(25px);
    }
    /* ğŸŒ™ ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .dark-mode {
      background-color: #222;
      color: #fff;
    }
    .dark-mode .post-container{
        background-color: #444444;
    }
    .dark-mode .clickable-category {
        cursor: pointer;
        color: white;
    }
    @media (max-width: 768px) {
  .post-container {
    width: 90%;        /* í™”ë©´ ë„ˆë¹„ì— ë§ê²Œ */
    padding: 20px;     /* íŒ¨ë”©ë„ ì¡°ê¸ˆ ì¤„ì„ */
    box-sizing: border-box;
  }

  .post-description {
    font-size: 14px;
  }

  .postcategory-container {
    flex-direction: column;   /* ì¢ì€ í™”ë©´ì—ì„œ ì„¸ë¡œ ì •ë ¬ */
    gap: 5px;
    text-align: center;
  }

  .post-buttons {
    flex-direction: column;  /* ë²„íŠ¼ ì„¸ë¡œ ë°°ì¹˜ */
  }

  .button {
    width: 100%;             /* ë²„íŠ¼ë„ ê½‰ ì°¨ê²Œ */
    max-width: 300px;
    margin: 5px auto;
  }
}
</style>
</head>
<body>
    <h1>ê²Œì‹œë¬¼</h1>
      <button id="picture" class="custom-button">ê·¸ë¦¬ê¸°</button>
            <!-- ğŸ”¥ ê·¸ë¦¼ ê·¸ë¦¬ê¸° íŒì—… -->
            <div id="drawing-popup" class="drawing-popup">
                <div class="popup-header">
                    <div class="popup-title">ê·¸ë¦¬ê¸°</div>
                    <button id="close-drawing" class="close-popup">âœ–</button>
                </div>
                <canvas id="drawingCanvas"></canvas>
                <div class="popup-footer">
                    <button id="clearCanvas">ì§€ìš°ê¸°</button>
                </div>
            </div>    
    <!-- âœ… ë¡œë”© í™”ë©´ ì¶”ê°€ -->
    <div id="loadingIndicator" class="loading-indicator">
      <img src="images/loading.gif" alt="ë¡œë”© ì¤‘..." class="loading-image">
      <p class="loading-text">ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

    <div class="post-container">
      <img id="postImage" class="post-image" src="" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">
        <!-- âœ… ì¹´í…Œê³ ë¦¬ & ì„œë¸Œì¹´í…Œê³ ë¦¬ í‘œì‹œ ê³µê°„ ì¶”ê°€ -->
        <div class="postcategory-container">
          <div class="post-category">
            <span id="postCategory" class="clickable-category"></span> â–¶ <span id="postSubcategory"></span>
          </div>
      </div>
      <p id="postDescription" class="post-description"></p>
    </div>

<!-- âœ… ë²„íŠ¼ ì¶”ê°€ -->
<div class="post-buttons">
  <button id="backToListButton" class="button">ëª©ë¡ìœ¼ë¡œ</button>
  <button id="shareButton" class="button">ê³µìœ </button>
</div>

    <!-- âœ… íŒì—… ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
<div id="popupMessage" class="popup-message" style="display: none;">
  <p id="popupText"></p>
  <button class="popup-button" onclick="closePopup()">í™•ì¸</button>
</div>

      <!-- ë‹¤í¬ ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
  <div class="toggle-switch">
    <input type="checkbox" id="themeToggle" onclick="toggleTheme()">
    <label class="slider" for="themeToggle">
      <span id="themeIcon">â˜€ï¸</span>
    </label>
  </div>

  <script>
    // âœ… ë¡œë”© í™”ë©´ í‘œì‹œ í•¨ìˆ˜
    function showLoading() {
        document.getElementById("loadingIndicator").style.display = "flex";
    }

    // âœ… ë¡œë”© í™”ë©´ ìˆ¨ê¹€ í•¨ìˆ˜
    function hideLoading() {
        setTimeout(() => {
            document.getElementById("loadingIndicator").style.display = "none";
        }, 500); // 0.5ì´ˆ í›„ ìˆ¨ê¹€
    }

    function showPopupMessage(message) {
      const popup = document.getElementById("popupMessage");
      const popupText = document.getElementById("popupText");

      popupText.textContent = message;
      popup.style.display = "block";
    }

    function closePopup() {
      document.getElementById("popupMessage").style.display = "none";
    }

    // âœ… URLì—ì„œ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸° (ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    function getParamsFromURL() {
        const params = new URLSearchParams(window.location.search);
        return {
            category: params.get("category") ? decodeURIComponent(params.get("category")).trim() : null,
            subcategory: params.get("subcategory") ? decodeURIComponent(params.get("subcategory")).trim() : null,
            file: params.get("file") ? decodeURIComponent(params.get("file")).trim() : null
        };
      }

    function convertHashtagsToLinks(text) {
      return text.replace(/#([\wê°€-í£]+)/g, (match, tag) => {
        const encoded = encodeURIComponent(tag);
        return `<a href="tagResults?tag=${encoded}" class="hashtag-link">#${tag}</a>`;
      });
    }

    // âœ… ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async function loadPostData() {
        let { category, subcategory, file } = getParamsFromURL();

        if (!file) {
            document.getElementById("postDescription").innerHTML = "ğŸš¨ ì˜¬ë°”ë¥¸ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        console.log(`ğŸ“Œ ìš”ì²­í•  íŒŒì¼ ì •ë³´: ${category} / ${subcategory} / ${file}`);

        // ğŸ”¥ ë¡œë”© ì‹œì‘
        showLoading();

        try {
          const apiURL = `/api/files/file?category=${encodeURIComponent(category)}&subcategory=${encodeURIComponent(subcategory)}&file=${encodeURIComponent(file)}`;
          console.log("ğŸ“Œ ìš”ì²­ URL:", apiURL);

          const response = await fetch(apiURL);

          if (!response.ok) {
              throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
          }

          const postData = await response.json();
          console.log("âœ… ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ ê²Œì‹œë¬¼ ë°ì´í„°:", postData);

          // âœ… ì´ë¯¸ì§€ ë° ì„¤ëª… ì ìš©
          document.getElementById("postImage").src = `${postData.file_path}`;
          document.getElementById("postCategory").textContent = postData.category_name || "ì¹´í…Œê³ ë¦¬ ì—†ìŒ";
          // âœ… ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ preview.htmlë¡œ ì´ë™
          document.getElementById("postCategory").addEventListener("click", () => {
              if (postData.category_name) {
                  const categoryParam = encodeURIComponent(postData.category_name);
                  window.location.href = `preview?category=${categoryParam}`;
              }
          });
          document.getElementById("postSubcategory").textContent = postData.subcategory_name || "ì„œë¸Œì¹´í…Œê³ ë¦¬ ì—†ìŒ";
          
          // âœ… ì„¤ëª… í•„í„°ë§ í›„ ì ìš© (HTML íƒœê·¸ ìœ ì§€)
          const convertedDescription = convertHashtagsToLinks(postData.file_description || "ì„¤ëª… ì—†ìŒ");
          document.getElementById("postDescription").innerHTML = convertedDescription.replace(/\n/g, "<br>");
        } catch (error) {
            console.error("ğŸš¨ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
            document.getElementById("postDescription").innerHTML = "ğŸš¨ ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        } finally {
            // ğŸ”¥ ë¡œë”© ì™„ë£Œ
            hideLoading();
        }
    }
    
    // âœ… HTML íƒœê·¸ ìœ ì§€ ë° ë¶ˆí•„ìš”í•œ íƒœê·¸ ì œê±°
    function sanitizeDescription(html) {
    // ê¸€ì íš¨ê³¼ë¥¼ ìœ„í•´ í•„ìš”í•œ íƒœê·¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const allowedTags = ["b", "strong", "i", "em", "s", "strike", "u", "br", "span", "div", "p"];
    let doc = new DOMParser().parseFromString(html, "text/html");

    doc.body.querySelectorAll("*").forEach(node => {
        if (!allowedTags.includes(node.tagName.toLowerCase())) {
            node.replaceWith(document.createTextNode(node.innerText));
        }
    });

    // ì¤„ë°”ê¿ˆ ê´€ë ¨ ì¹˜í™˜ ì œê±° â€“ ì—”í„° 1ë²ˆìœ¼ë¡œ ìƒì„±ëœ <br>ê°€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨
    return doc.body.innerHTML.trim();
  }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener("DOMContentLoaded",()=>{
      loadPostData();
      bindDrawingEvents();        // ğŸ”¥ ì´ ì¤„ ì¶”ê°€
    });

    // âœ… "ëª©ë¡ìœ¼ë¡œ" ë²„íŠ¼ í´ë¦­ ì‹œ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
    document.getElementById("backToListButton").addEventListener("click", () => {
      window.history.back(); // ğŸ”¥ ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
    });

    // âœ… "ê³µìœ " ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ í˜ì´ì§€ URL ë³µì‚¬
    document.getElementById("shareButton").addEventListener("click", async () => {
      try {
          const postURL = window.location.href;
          await navigator.clipboard.writeText(postURL);
          showPopupMessage("ğŸ“Œ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (err) {
          console.error("ğŸš¨ ê³µìœ  ì‹¤íŒ¨:", err);
          showPopupMessage("âŒ ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
      function bindDrawingEvents(){
        const drawingPopup = document.getElementById("drawing-popup");
        const openDrawingBtn = document.getElementById("picture");
        const closeDrawingBtn = document.getElementById("close-drawing");
        const clearCanvasBtn = document.getElementById("clearCanvas");
        const canvas = document.getElementById("drawingCanvas");
        const ctx = canvas.getContext("2d");

        let isDrawing = false;

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        canvas.width = 500;
        canvas.height = 300;


        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: e.offsetX,
                    y: e.offsetY
                };
            }
        }

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        canvas.addEventListener("mousedown", function (e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        // ê·¸ë¦¬ê¸° ì¤‘
        canvas.addEventListener("mousemove", function (e) {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        });        
        
        // ê·¸ë¦¬ê¸° ì¢…ë£Œ
        canvas.addEventListener("mouseup", function () {
            isDrawing = false;
        });

        canvas.addEventListener("mouseleave", function () {
            isDrawing = false;
        });

         // í„°ì¹˜ ì´ë²¤íŠ¸
        canvas.addEventListener("touchstart", function (e) {
            isDrawing = true;
            const { x, y } = getCanvasCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(x, y);
            e.preventDefault();
        }, { passive: false });

        canvas.addEventListener("touchmove", function (e) {
            if (!isDrawing) return;
            const { x, y } = getCanvasCoordinates(e);
            ctx.lineTo(x, y);
            ctx.stroke();
            e.preventDefault();
        }, { passive: false });

        canvas.addEventListener("touchend", function () {
            isDrawing = false;
        });

        // íŒì—… ì—´ê¸°
        openDrawingBtn.addEventListener("click", function () {
            drawingPopup.style.display = "block";

            // ğŸ”¥ canvas í¬ê¸°ë¥¼ í™”ë©´ í‘œì‹œ í¬ê¸°ì— ë§ì¶° ì¬ì„¤ì •
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        });

        // íŒì—… ë‹«ê¸°
        closeDrawingBtn.addEventListener("click", function () {
            drawingPopup.style.display = "none";
        });

        // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
        clearCanvasBtn.addEventListener("click", function () {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }); 
    }

    // **ğŸ¨ ê·¸ë¦¬ê¸° ê¸°ëŠ¥ ì¶”ê°€ (Drawing Feature)**
    function initDrawingCanvas() {
        const canvas = document.getElementById("drawingCanvas");
        const ctx = canvas.getContext("2d");
        let drawing = false;
    
        canvas.width = 500;
        canvas.height = 400;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    
        canvas.addEventListener("mousedown", () => drawing = true);
        canvas.addEventListener("mouseup", () => drawing = false);
        canvas.addEventListener("mousemove", draw);
    
        function draw(event) {
            if (!drawing) return;
            ctx.lineWidth = 5;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
            ctx.lineTo(event.clientX - canvas.offsetLeft, event.clientY - canvas.offsetTop);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(event.clientX - canvas.offsetLeft, event.clientY - canvas.offsetTop);
        }
    
        document.getElementById("clearCanvas").addEventListener("click", () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });
    }

    // âœ… ë‹¤í¬ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜
    function toggleTheme() {
      const body = document.body;
      const isDarkMode = body.classList.toggle("dark-mode");
      const themeIcon = document.getElementById("themeIcon");

      if (isDarkMode) {
        localStorage.setItem("theme", "dark");
        themeToggle.checked = true;
        if (themeIcon) themeIcon.textContent = "ğŸ’¤";
    } else {
        localStorage.setItem("theme", "light");
        themeToggle.checked = false;
        if (themeIcon) themeIcon.textContent = "â˜€ï¸";
      }
    }

function applySavedTheme() {
  const savedTheme = localStorage.getItem("theme") || "light";
  const themeIcon = document.getElementById("themeIcon");

  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    themeToggle.checked = true;
    if (themeIcon) themeIcon.textContent = "ğŸ’¤";
  } else {
    document.body.classList.remove("dark-mode");
    themeToggle.checked = false;
    if (themeIcon) themeIcon.textContent = "â˜€ï¸";
  }
}
</script>
  </body>
  </html>

